import unittest

import pandas as pd

from scripts import FilePaths
from scripts.documents_weights import DocumentsWeights


class TestDocumentsWeights(unittest.TestCase):
    @classmethod
    def setUp(cls):
        super(TestDocumentsWeights, cls).setUpClass()
        df = pd.read_pickle(FilePaths.us_patents_random_100_pickle_name)
        cls.__df = df.reset_index()

    @unittest.skip("we need to revisit citations to not rely on patent_id or other id")
    def test_citations(self):
        citation_count_dict = pd.read_pickle(FilePaths.us_patents_citation_dictionary_1of2_pickle_name)
        citation_count_dict_pt2 = pd.read_pickle(FilePaths.us_patents_citation_dictionary_2of2_pickle_name)
        citation_count_dict.update(citation_count_dict_pt2)

        expected = [0.39753537197626654,
                    0.24843897824030275,
                    0.2200248928225695,
                    0.3446654611211573,
                    0.226240286909743,
                    0.29440521455730584,
                    0.23323615160349856,
                    0.24733196030705862,
                    0.23406341941811049,
                    0.2946938775510204,
                    0.3667736757624398,
                    0.5714285714285714,
                    0.40336134453781514,
                    0.2537254122789589,
                    0.2600840336134454,
                    0.5188679245283019,
                    0.30228571428571427,
                    0.4085714285714286,
                    0.2737508796622097,
                    0.30997304582210244,
                    0.3588850174216028,
                    0.21064139941690962,
                    0.26418786692759294,
                    0.324853228962818,
                    0.26455834242093784,
                    0.23084200567644278,
                    0.27505330490405117,
                    0.21784706356672492,
                    0.40681173131504256,
                    0.26308985132514545,
                    0.2,
                    0.2349059716265259,
                    0.2350123864574732,
                    0.24151343705799153,
                    0.3184392699811202,
                    0.23469387755102042,
                    0.3401697312588402,
                    0.2640034737299175,
                    0.21756593921542378,
                    0.3554285714285714,
                    0.3340184994861254,
                    0.2240325865580448,
                    0.24312668463611858,
                    0.45669291338582674,
                    0.20673076923076925,
                    0.2343775627357717,
                    0.29075006626027033,
                    0.27163627971382415,
                    0.3176691729323308,
                    0.232222934016656,
                    0.2991596638655462,
                    0.22297200287150037,
                    0.35714285714285715,
                    0.22563417890520696,
                    0.35830115830115833,
                    0.3526315789473684,
                    0.22694394213381555,
                    0.2958596106388813,
                    0.3391977480647431,
                    0.23995127892813642,
                    1.0,
                    0.2929782082324455,
                    0.29213483146067415,
                    0.5224489795918368,
                    0.22085546547386078,
                    0.2788883471477328,
                    0.26025667999158425,
                    0.3013348480545299,
                    0.23663865546218488,
                    0.25326474079936684,
                    0.9167822468793341,
                    0.33042016806722685,
                    0.6319018404907975,
                    0.22866369367984007,
                    0.40946010511227904,
                    0.22978657111699644,
                    0.23323615160349856,
                    0.2363088259922961,
                    0.4987244897959183,
                    0.29213483146067415,
                    0.2575539568345324,
                    0.2979433018343524,
                    0.3446654611211573,
                    0.24544953116381688,
                    0.4059405940594059,
                    0.3068783068783069,
                    0.22589285714285715,
                    0.23469387755102042,
                    0.23045525902668762,
                    0.26918723115236587,
                    0.27461629279811095,
                    0.23282811996130282,
                    0.2311343141907926,
                    0.23832335329341317,
                    0.33042016806722685,
                    0.24571428571428572,
                    0.24325296869377475,
                    0.2834467120181406,
                    0.2973421926910299,
                    0.2805329385640266]

        doc_weights = DocumentsWeights(self.__df, False, citation_count_dict, 'publication_date', norm_rows=True).weights
        actual = list(doc_weights)
        self.assertListEqual(expected, actual)

    def test_normalized(self):
        expected_weights = [1 / 5, 1 / 2, 1 / 4, 1]

        actual_weights = DocumentsWeights(self.__df, False, None, 'publication_date', [5, 2, 4, 1],
                                          norm_rows=True).weights

        self.assertListEqual(expected_weights, actual_weights)

    def test_time(self):
        expected = [0.2,
                    0.22222222222222224,
                    0.256140350877193,
                    0.26900584795321636,
                    0.2994152046783626,
                    0.2994152046783626,
                    0.31578947368421056,
                    0.3263157894736842,
                    0.34269005847953216,
                    0.34385964912280703,
                    0.34619883040935673,
                    0.3485380116959065,
                    0.3543859649122807,
                    0.35789473684210527,
                    0.37192982456140355,
                    0.39883040935672515,
                    0.4210526315789474,
                    0.4222222222222223,
                    0.4280701754385965,
                    0.43391812865497076,
                    0.4912280701754386,
                    0.49473684210526314,
                    0.4982456140350877,
                    0.5005847953216375,
                    0.5169590643274854,
                    0.5192982456140351,
                    0.5345029239766081,
                    0.5380116959064327,
                    0.5567251461988305,
                    0.560233918128655,
                    0.5625730994152047,
                    0.5695906432748539,
                    0.5789473684210527,
                    0.5812865497076023,
                    0.6058479532163743,
                    0.6128654970760234,
                    0.6152046783625731,
                    0.616374269005848,
                    0.6269005847953216,
                    0.6292397660818714,
                    0.6362573099415205,
                    0.6432748538011697,
                    0.6432748538011697,
                    0.6467836257309942,
                    0.6514619883040936,
                    0.657309941520468,
                    0.6596491228070176,
                    0.6596491228070176,
                    0.6795321637426901,
                    0.6830409356725147,
                    0.7099415204678363,
                    0.7099415204678363,
                    0.7228070175438597,
                    0.7286549707602339,
                    0.7415204678362575,
                    0.7555555555555555,
                    0.7625730994152047,
                    0.7649122807017543,
                    0.7672514619883042,
                    0.7859649122807018,
                    0.7894736842105263,
                    0.7894736842105263,
                    0.7964912280701755,
                    0.8,
                    0.8035087719298246,
                    0.8140350877192983,
                    0.8175438596491229,
                    0.8198830409356725,
                    0.8280701754385966,
                    0.8374269005847954,
                    0.8444444444444446,
                    0.8467836257309942,
                    0.8502923976608188,
                    0.8502923976608188,
                    0.8514619883040937,
                    0.8526315789473684,
                    0.8538011695906433,
                    0.8596491228070176,
                    0.8666666666666667,
                    0.8736842105263158,
                    0.87953216374269,
                    0.8842105263157896,
                    0.8900584795321638,
                    0.8947368421052633,
                    0.895906432748538,
                    0.9029239766081871,
                    0.9029239766081871,
                    0.9040935672514621,
                    0.9087719298245613,
                    0.9146198830409358,
                    0.9274853801169591,
                    0.9508771929824562,
                    0.9625730994152046,
                    0.9777777777777779,
                    0.9789473684210528,
                    0.9801169590643275,
                    0.9824561403508774,
                    0.9906432748538012,
                    1.0,
                    1.0]
        doc_weights = DocumentsWeights(self.__df, True, None, 'publication_date').weights
        actual = list(doc_weights)
        self.assertListEqual(expected, actual)


if __name__ == '__main__':
    unittest.main()
